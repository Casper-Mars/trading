# QA测试用例文档 - 数据采集子系统

## 文档信息

| 项目    | 内容          |
| ----- | ----------- |
| 子系统名称 | 量化平台数据采集子系统 |
| 文档版本  | v1.0        |
| 创建日期  | 2024-12-19  |
| 最后更新  | 2024-12-19  |
| 测试负责人 | QA测试团队 |
| 文档状态  | 待评审         |
| 所属平台  | 量化交易平台      |

## 概述

数据采集子系统是量化交易平台的核心基础设施，负责从多个数据源采集金融数据，通过FinBERT模型进行智能NLP处理，并为回测系统和量化系统提供统一的RESTful API服务。

**测试范围**：
- Tushare数据采集功能
- 新闻数据采集和NLP处理功能
- HTTP API接口服务
- 数据质量管控功能
- 查询服务和缓存机制
- 系统集成和端到端流程

**测试目标**：
- 验证所有功能需求的正确实现
- 确保系统稳定性和性能满足要求
- 验证用户场景的完整性和可用性
- 确保数据质量和一致性

## 测试策略

### 测试方法
- **功能测试**：验证各功能模块按需求正常工作
- **集成测试**：验证模块间交互和数据流转
- **接口测试**：验证API接口的正确性和稳定性
- **性能测试**：验证系统响应时间和并发处理能力
- **数据测试**：验证数据采集、处理和存储的准确性

### 测试重点
- API接口的功能完整性和错误处理
- 数据采集的准确性和完整性
- NLP处理的准确性和性能
- 系统异常情况的处理能力
- 用户关键路径的完整性

### 测试环境要求
- 测试环境与生产环境配置一致
- 独立的测试数据库和缓存
- 模拟的外部数据源（Tushare API、新闻网站）
- 完整的日志和监控配置

## 测试用例

### 功能测试用例

#### TC001: Tushare数据采集功能测试

**测试目标**: 验证Tushare数据采集功能的完整性和准确性

**前置条件**: 
- 系统已正确配置Tushare API密钥
- 数据库连接正常
- 网络连接稳定

**测试步骤**:
1. 启动数据采集服务
2. 执行股票基础信息采集任务
3. 执行日线数据采集任务
4. 执行财务数据采集任务
5. 检查数据库中的数据完整性
6. 验证数据格式和字段完整性

**预期结果**:
- 股票基础信息采集成功，包含股票代码、名称、行业等字段
- 日线数据采集成功，包含OHLCV等字段
- 财务数据采集成功，包含利润表、资产负债表等数据
- 数据格式符合数据库模型定义
- 采集过程有完整的日志记录

**优先级**: 高

#### TC002: 新闻数据采集功能测试

**测试目标**: 验证新闻数据采集和预处理功能

**前置条件**:
- 新闻爬虫配置正确
- 目标网站可正常访问
- 数据库连接正常

**测试步骤**:
1. 启动新闻采集服务
2. 执行新闻爬取任务
3. 检查爬取的新闻数据质量
4. 验证新闻内容预处理结果
5. 检查新闻去重机制
6. 验证新闻与股票的关联逻辑

**预期结果**:
- 新闻采集成功，包含标题、内容、来源、发布时间等字段
- 新闻内容格式正确，无乱码或格式错误
- 去重机制有效，无重复新闻
- 新闻与股票关联准确
- 遵守robots.txt规则，访问频率合理

**优先级**: 高

#### TC003: FinBERT情感分析功能测试

**测试目标**: 验证FinBERT模型的情感分析准确性和性能

**前置条件**:
- FinBERT模型已正确加载
- 有待处理的新闻数据
- NLP服务正常运行

**测试步骤**:
1. 准备测试新闻文本（包含明显正面、负面、中性情感的文本）
2. 执行情感分析任务
3. 检查情感分析结果的准确性
4. 验证置信度和情感强度的合理性
5. 测试批量处理性能
6. 验证实体识别和关键词提取功能

**预期结果**:
- 情感分析结果准确，能正确识别正面、负面、中性情感
- 置信度在0-1范围内，数值合理
- 情感强度级别（1-10）符合预期
- 实体识别准确，能识别公司、人物、事件等
- 关键词提取合理，能提取核心信息
- 批量处理性能满足要求（单条新闻处理时间<5秒）

**优先级**: 高

#### TC004: 数据质量验证功能测试

**测试目标**: 验证数据质量管控功能的有效性

**前置条件**:
- 数据质量服务正常运行
- 有测试数据（包含正常数据和异常数据）

**测试步骤**:
1. 准备包含格式错误的测试数据
2. 执行数据格式验证
3. 准备包含缺失字段的测试数据
4. 执行数据完整性检查
5. 准备包含异常值的测试数据
6. 执行异常值检测
7. 测试数据清洗功能
8. 验证数据备份机制

**预期结果**:
- 格式错误的数据被正确识别和拒绝
- 缺失字段的数据被检测并记录
- 异常值被正确识别和标记
- 数据清洗功能正常，能修正可修复的数据问题
- 数据备份机制有效，原始数据得到保留
- 质量问题有详细的错误报告

**优先级**: 中

### API接口测试用例

#### TC005: 股票基础信息API测试

**测试目标**: 验证股票基础信息查询API的功能完整性

**测试步骤**:
1. 测试正常查询：`GET /api/v1/stocks/basic?limit=10`
2. 测试分页查询：`GET /api/v1/stocks/basic?page=2&limit=5`
3. 测试排序查询：`GET /api/v1/stocks/basic?sort_by=symbol&sort_order=desc`
4. 测试过滤查询：`GET /api/v1/stocks/basic?industry=银行`
5. 测试无效参数：`GET /api/v1/stocks/basic?limit=-1`
6. 测试超大分页：`GET /api/v1/stocks/basic?limit=10000`

**预期结果**:
- 正常查询返回状态码200，数据格式正确
- 分页功能正常，分页信息准确
- 排序功能正常，数据按指定字段排序
- 过滤功能正常，返回符合条件的数据
- 无效参数返回400错误，错误信息明确
- 超大分页请求被限制，返回合理的错误信息

**优先级**: 高

#### TC006: 股票日线数据API测试

**测试目标**: 验证股票日线数据查询API的功能

**测试步骤**:
1. 测试按股票代码查询：`GET /api/v1/stocks/daily?symbol=000001.SZ`
2. 测试日期范围查询：`GET /api/v1/stocks/daily?start_date=2024-01-01&end_date=2024-01-31`
3. 测试组合条件查询：`GET /api/v1/stocks/daily?symbol=000001.SZ&start_date=2024-01-01&end_date=2024-01-31`
4. 测试无效股票代码：`GET /api/v1/stocks/daily?symbol=INVALID`
5. 测试无效日期格式：`GET /api/v1/stocks/daily?start_date=2024-13-01`
6. 测试日期范围倒置：`GET /api/v1/stocks/daily?start_date=2024-01-31&end_date=2024-01-01`

**预期结果**:
- 有效查询返回正确的日线数据
- 日期范围查询返回指定时间段的数据
- 组合条件查询结果准确
- 无效股票代码返回404或空结果
- 无效日期格式返回400错误
- 日期范围倒置返回400错误或空结果

**优先级**: 高

#### TC007: 新闻数据API测试

**测试目标**: 验证新闻数据查询API的功能

**测试步骤**:
1. 测试基础查询：`GET /api/v1/news/?limit=10`
2. 测试按股票代码查询：`GET /api/v1/news/?symbol=000001.SZ`
3. 测试日期范围查询：`GET /api/v1/news/?start_date=2024-01-01&end_date=2024-01-31`
4. 测试关键词搜索：`GET /api/v1/news/?keyword=财报`
5. 测试组合查询：`GET /api/v1/news/?symbol=000001.SZ&keyword=业绩`
6. 测试空关键词：`GET /api/v1/news/?keyword=`

**预期结果**:
- 基础查询返回最新的新闻数据
- 按股票代码查询返回相关新闻
- 日期范围查询返回指定时间段的新闻
- 关键词搜索返回包含关键词的新闻
- 组合查询结果准确
- 空关键词查询返回所有新闻或适当的错误信息

**优先级**: 高

#### TC008: 情感分析API测试

**测试目标**: 验证情感分析结果查询API的功能

**测试步骤**:
1. 测试基础查询：`GET /api/v1/news/sentiment?limit=10`
2. 测试按股票代码查询：`GET /api/v1/news/sentiment?symbol=000001.SZ`
3. 测试情感类型过滤：`GET /api/v1/news/sentiment?sentiment=positive`
4. 测试置信度过滤：`GET /api/v1/news/sentiment?min_confidence=0.8`
5. 测试情感统计：`GET /api/v1/news/sentiment/stats?symbol=000001.SZ`
6. 测试无效情感类型：`GET /api/v1/news/sentiment?sentiment=invalid`

**预期结果**:
- 基础查询返回情感分析结果
- 按股票代码查询返回相关股票的情感数据
- 情感类型过滤正常工作
- 置信度过滤返回高置信度的结果
- 情感统计返回各情感类型的数量和比例
- 无效情感类型返回400错误

**优先级**: 高

#### TC009: 手动数据采集API测试

**测试目标**: 验证手动触发数据采集功能的完整性

**测试步骤**:
1. 测试全量数据采集：`POST /api/v1/collection/full`
2. 验证任务创建：检查响应中的task_id
3. 查询任务状态：`GET /api/v1/collection/tasks/{task_id}`
4. 监控任务进度：定期查询任务状态直到完成
5. 验证数据更新：通过股票API查询验证数据是否更新
6. 测试增量采集：`POST /api/v1/collection/incremental`
7. 测试指定股票采集：`POST /api/v1/collection/stocks` with `{"stock_codes": ["000001.SZ"]}`
8. 测试日期范围采集：`POST /api/v1/collection/range` with `{"start_date": "2024-01-01", "end_date": "2024-01-31"}`

**预期结果**:
- 全量采集任务成功创建并执行
- 任务状态正确流转（pending→running→completed）
- 数据库中数据得到正确更新
- 增量采集只更新最新数据
- 指定股票采集只处理指定股票
- 日期范围采集只处理指定时间段数据

**优先级**: 高

#### TC010: 采集任务管理测试

**测试目标**: 验证采集任务的管理和控制功能

**测试步骤**:
1. 创建多个采集任务：同时触发多个不同类型的采集
2. 查询任务列表：`GET /api/v1/collection/tasks?limit=10`
3. 测试任务过滤：`GET /api/v1/collection/tasks?status=running`
4. 测试任务分页：`GET /api/v1/collection/tasks?page=2&limit=5`
5. 创建长时间运行的任务
6. 取消运行中的任务：`DELETE /api/v1/collection/tasks/{task_id}`
7. 验证任务取消效果：确认任务状态变为cancelled
8. 测试并发任务限制：创建超过系统限制的任务数量

**预期结果**:
- 支持多任务并发执行
- 任务列表查询正常
- 状态过滤和分页功能正常
- 任务取消功能正常工作
- 任务实际停止执行
- 并发任务数量控制有效

**优先级**: 高

#### TC011: 手动采集错误处理测试

**测试目标**: 验证手动采集功能的错误处理能力

**测试步骤**:
1. 测试无效股票代码：`POST /api/v1/collection/stocks` with `{"stock_codes": ["INVALID"]}`
2. 测试无效日期格式：`POST /api/v1/collection/range` with `{"start_date": "invalid-date"}`
3. 测试日期范围倒置：`POST /api/v1/collection/range` with `{"start_date": "2024-01-31", "end_date": "2024-01-01"}`
4. 测试空请求体：`POST /api/v1/collection/stocks` with empty body
5. 测试查询不存在的任务：`GET /api/v1/collection/tasks/invalid-id`
6. 测试取消不存在的任务：`DELETE /api/v1/collection/tasks/invalid-id`
7. 测试取消已完成的任务：`DELETE /api/v1/collection/tasks/{completed_task_id}`
8. 模拟网络异常：断开Tushare连接后触发采集

**预期结果**:
- 无效股票代码返回400错误和详细错误信息
- 无效日期格式返回400错误
- 日期范围倒置返回400错误
- 空请求体返回400错误
- 不存在的任务返回404错误
- 取消不存在任务返回404错误
- 取消已完成任务返回适当的错误信息
- 网络异常时任务状态更新为failed

**优先级**: 高

### 集成测试用例

#### TC012: 端到端数据流测试

**测试目标**: 验证从数据采集到API查询的完整数据流

**测试步骤**:
1. 清空测试数据库
2. 启动完整的数据采集流程
3. 等待数据采集完成
4. 执行新闻采集和NLP处理
5. 通过API查询采集的数据
6. 验证数据的一致性和完整性
7. 检查数据处理的时效性

**预期结果**:
- 数据采集流程正常执行
- 新闻NLP处理正常完成
- API能查询到采集的数据
- 数据在各个环节保持一致性
- 数据处理时效性满足要求

**优先级**: 高

#### TC013: 手动采集与定时采集集成测试

**测试目标**: 验证手动采集与定时采集的协调工作

**测试步骤**:
1. 配置定时采集任务
2. 在定时任务运行期间触发手动采集
3. 验证任务冲突处理机制
4. 检查数据一致性
5. 验证任务优先级处理
6. 测试资源竞争情况
7. 验证任务队列管理

**预期结果**:
- 手动采集和定时采集能协调工作
- 任务冲突得到正确处理
- 数据一致性得到保证
- 任务优先级机制有效
- 资源竞争处理正常
- 任务队列管理有效

**优先级**: 高

#### TC014: 缓存机制集成测试

**测试目标**: 验证Redis缓存在整个系统中的作用

**测试步骤**:
1. 清空Redis缓存
2. 执行API查询，记录响应时间
3. 再次执行相同查询，记录响应时间
4. 验证缓存命中情况
5. 等待缓存过期，再次查询
6. 验证缓存更新机制

**预期结果**:
- 首次查询从数据库获取数据
- 第二次查询从缓存获取，响应时间明显缩短
- 缓存命中率符合预期
- 缓存过期后能正确更新
- 缓存机制提升系统性能

**优先级**: 中

#### TC011: 错误处理和恢复测试

**测试目标**: 验证系统在异常情况下的处理能力

**测试步骤**:
1. 模拟数据库连接中断
2. 模拟Tushare API调用失败
3. 模拟新闻网站访问被阻止
4. 模拟FinBERT模型处理失败
5. 模拟Redis缓存服务中断
6. 验证系统的错误处理和恢复机制

**预期结果**:
- 数据库连接中断时，系统能优雅降级
- API调用失败时，有重试机制和错误记录
- 网站访问被阻止时，能切换到备用策略
- 模型处理失败时，任务被标记为待处理
- 缓存服务中断时，系统能直接查询数据库
- 所有异常都有详细的日志记录

**优先级**: 中

### 性能测试用例

#### TC012: API响应性能测试

**测试目标**: 验证API接口的响应性能

**测试步骤**:
1. 使用性能测试工具（如JMeter）
2. 对各API接口进行并发请求测试
3. 测试不同数据量下的响应时间
4. 测试系统在高并发下的稳定性
5. 监控系统资源使用情况

**预期结果**:
- 95%的查询请求在2秒内响应
- 系统能处理预期的并发用户数
- 高并发情况下系统保持稳定
- 系统资源使用合理

**优先级**: 中

#### TC013: 数据处理性能测试

**测试目标**: 验证数据采集和处理的性能

**测试步骤**:
1. 测试大批量股票数据采集的时间
2. 测试新闻批量处理的性能
3. 测试FinBERT模型的处理速度
4. 监控内存和CPU使用情况

**预期结果**:
- 日度数据更新在30分钟内完成
- 单条新闻处理时间不超过5秒
- 批量处理效率符合预期
- 系统资源使用在合理范围内

**优先级**: 中

### 边界测试用例

#### TC014: 数据边界值测试

**测试目标**: 验证系统对边界数据的处理能力

**测试步骤**:
1. 测试空数据的处理
2. 测试超长文本的处理
3. 测试特殊字符的处理
4. 测试极值数据的处理
5. 测试数据类型边界值

**预期结果**:
- 空数据得到适当处理，不引起系统错误
- 超长文本被正确截断或分段处理
- 特殊字符不影响数据处理和存储
- 极值数据得到正确验证和处理
- 数据类型边界值处理正确

**优先级**: 低

#### TC015: 并发访问边界测试

**测试目标**: 验证系统在极限并发情况下的表现

**测试步骤**:
1. 逐步增加并发用户数
2. 监控系统响应时间变化
3. 找到系统性能拐点
4. 测试超过系统承载能力的并发数
5. 验证系统的保护机制

**预期结果**:
- 系统在设计承载范围内正常工作
- 超过承载能力时有适当的保护机制
- 系统不会因过载而崩溃
- 有合理的错误提示和降级策略

**优先级**: 低

### 用户场景测试用例

#### TC016: 量化系统数据获取场景

**测试目标**: 模拟量化系统获取数据的完整场景

**测试步骤**:
1. 量化系统启动，需要获取股票基础信息
2. 调用股票基础信息API，获取全A股列表
3. 根据策略需求，获取特定股票的历史数据
4. 调用日线数据API，获取指定时间段的行情数据
5. 获取相关新闻和情感分析数据
6. 调用新闻和情感分析API
7. 验证获取的数据完整性和准确性

**预期结果**:
- 能成功获取所需的股票基础信息
- 历史行情数据完整准确
- 新闻和情感数据与股票正确关联
- 数据格式符合量化系统的要求
- 整个数据获取流程顺畅无阻

**优先级**: 高

#### TC017: 回测系统历史数据获取场景

**测试目标**: 模拟回测系统获取历史数据的场景

**测试步骤**:
1. 回测系统需要获取某只股票的完整历史数据
2. 调用API获取股票基础信息
3. 调用API获取历史日线数据（大时间跨度）
4. 调用API获取历史财务数据
5. 调用API获取历史新闻和情感数据
6. 验证数据的连续性和完整性

**预期结果**:
- 能获取完整的历史数据
- 数据时间序列连续，无缺失
- 财务数据按报告期正确组织
- 新闻数据与时间点正确对应
- 数据量满足回测需求

**优先级**: 高

#### TC018: 数据监控和运维场景

**测试目标**: 模拟运维人员监控数据采集状态的场景

**测试步骤**:
1. 运维人员需要检查数据采集状态
2. 调用系统健康检查接口
3. 检查数据采集任务的执行状态
4. 查看数据质量报告
5. 检查系统性能指标
6. 验证告警机制的有效性

**预期结果**:
- 能获取系统整体健康状态
- 数据采集任务状态清晰可见
- 数据质量问题能及时发现
- 性能指标在合理范围内
- 异常情况能及时告警

**优先级**: 中

## 测试数据准备

### 股票数据
- **测试股票代码**: 000001.SZ（平安银行）、000002.SZ（万科A）、600000.SH（浦发银行）
- **测试时间范围**: 2024-01-01 至 2024-12-31
- **数据类型**: 基础信息、日线数据、财务数据

### 新闻数据
- **测试新闻来源**: 财经网站的公开新闻
- **新闻类型**: 公司公告、行业新闻、市场分析
- **情感类型**: 包含明显正面、负面、中性情感的新闻

### 测试账号
- **Tushare账号**: 测试专用API密钥
- **数据库账号**: 测试环境专用账号
- **Redis账号**: 测试环境专用配置

## 测试环境要求

### 硬件环境
- **CPU**: 4核心以上
- **内存**: 8GB以上
- **存储**: 100GB以上可用空间
- **网络**: 稳定的互联网连接

### 软件环境
- **操作系统**: Linux/macOS
- **Python**: 3.11+
- **数据库**: MySQL 8.0+, Redis 7.0+
- **依赖管理**: UV

### 配置要求
- 独立的测试数据库实例
- 独立的Redis缓存实例
- 完整的环境变量配置
- 日志和监控配置

### 测试工具
- **API测试**: Postman/Insomnia
- **性能测试**: JMeter/Locust
- **数据库工具**: MySQL Workbench/DBeaver
- **缓存工具**: Redis CLI/RedisInsight

## 验收标准

### 功能验收标准
- [ ] 所有高优先级测试用例100%通过
- [ ] 所有中优先级测试用例95%以上通过
- [ ] 所有API接口功能正常
- [ ] 数据采集功能稳定可靠
- [ ] NLP处理功能准确有效
- [ ] 数据质量管控机制有效

### 性能验收标准
- [ ] API响应时间：95%请求在2秒内响应
- [ ] 数据采集效率：日度数据更新在30分钟内完成
- [ ] NLP处理效率：单条新闻处理时间不超过5秒
- [ ] 系统稳定性：连续运行7天无重大故障
- [ ] 并发处理能力：支持预期的并发用户数

### 质量验收标准
- [ ] 数据准确性：采集数据与源数据一致性达到99%以上
- [ ] 数据完整性：关键数据字段完整性达到95%以上
- [ ] 情感分析准确性：情感分析准确率达到80%以上
- [ ] 错误处理：所有异常情况都有适当的错误处理
- [ ] 日志记录：关键操作都有完整的日志记录

### 用户体验验收标准
- [ ] API接口易于使用，文档清晰完整
- [ ] 错误信息明确，便于问题定位
- [ ] 系统响应及时，用户等待时间合理
- [ ] 数据格式标准，便于集成使用

## 风险评估

### 高风险项
- **外部依赖风险**: Tushare API限制、新闻网站反爬虫
- **性能风险**: 大数据量处理、FinBERT模型推理性能
- **数据质量风险**: 数据源质量变化、数据格式变更

### 中风险项
- **环境风险**: 测试环境稳定性、网络连接问题
- **集成风险**: 模块间接口变更、依赖版本冲突
- **时间风险**: 测试时间不足、问题修复时间

### 风险缓解措施
- 提前准备备用数据源和测试数据
- 建立完善的测试环境和数据备份机制
- 制定详细的测试计划和应急预案
- 加强与开发团队的沟通协作

## 修改记录

### [2024-12-19] v1.0 初始版本创建

**创建内容**：
1. **测试用例设计**：基于需求文档设计了18个核心测试用例
2. **测试分类**：包含功能测试、API接口测试、集成测试、性能测试、边界测试、用户场景测试
3. **测试策略**：明确了测试方法、重点和环境要求
4. **验收标准**：制定了功能、性能、质量、用户体验四个维度的验收标准
5. **风险评估**：识别了主要风险项并提供了缓解措施

**测试特点**：
- 面向QA测试人员的完整测试指南
- 覆盖系统的所有核心功能和关键路径
- 提供具体的测试步骤和预期结果
- 包含性能和边界测试的考虑
- 支持用户场景的端到端验证

**技术对齐**：
- 基于requirements.md的功能需求设计测试用例
- 符合design_backend.md的技术架构
- 覆盖已实现的API接口和核心服务
- 支持MVP版本的质量保证要求

### [2024-12-19] v1.1 手动数据采集功能测试用例新增

**新增内容**：
1. **手动数据采集API测试**：新增TC009测试用例，覆盖全量、增量、指定股票、日期范围四种采集模式
2. **采集任务管理测试**：新增TC010测试用例，验证任务创建、查询、取消等管理功能
3. **手动采集错误处理测试**：新增TC011测试用例，验证各种异常情况的处理能力
4. **手动采集与定时采集集成测试**：新增TC013测试用例，验证手动采集与定时采集的协调工作
5. **测试用例编号调整**：原TC009-TC010调整为TC012-TC014，保持编号连续性

**测试覆盖增强**：
- 新增手动数据采集功能的完整测试覆盖
- 增强了任务管理和状态跟踪的测试验证
- 完善了错误处理和异常情况的测试场景
- 加强了系统集成和协调工作的测试验证

**功能对齐**：
- 基于新增的REQ-6需求设计测试用例
- 覆盖design_backend.md中新增的手动采集API接口
- 支持tasks.md中第5周手动数据采集模块的质量保证
- 确保手动采集功能的稳定性和可靠性